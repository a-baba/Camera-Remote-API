<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="/frameworks/jquery-1.11.1.min.js"></script>
    <script src="/lib/requestSession_sim.js"></script>
    <style>
      #simif { display: none; }
    </style>
  </head>
  <body>
    <div id="simif"></div>
    <section id="main">
      <header>
        <h1>WoT demo</h1>
      </header>

      <section id="contents">
        <div class="content"></div>
      </section>
    </section>

    <img id="liveview"><canvas></canvas>
  </body>
  <script>
    // #simifの属性変更検知をセットする(Extensionから、
    // データを貰うために用いる
    function setInterface(callback) {
      // interface node
      var target = document.querySelector("#simif");

      // create an observer instance
      var observer = new MutationObserver(function(mutations){
        var res = {};
        mutations.forEach(function(mutation) {
          var attr = mutation.attributeName;
          res[attr] = target.getAttribute(attr);
        });
        if(typeof(callback) === "function") {
          callback(res);
        } else {
          console.log(res);
        }
      });

      // indicates target and option
      observer.observe(target, { attributes: true });
    }

    // setInterfaceのテスト
    setInterface(function(res) {
      window.alert("Detected : " + JSON.stringify(res));
    });

    // live view test
    var ws = new WebSocket("ws://localhost:28888");
    console.log(ws)

    ws.onopen = function(ev){
      var req = {"method": "liveview"};
      setTimeout(function(){
        ws.send(JSON.stringify(req));
        console.log("ws://localhost:28888 send " + JSON.stringify(req))
      }, 5000);
    };

    ws.onmessage = function(mesg) {
      console.log("on message ================================================");
      console.log(mesg.data);
      var url = window.URL.createObjectURL(mesg.data);
      console.log(url);
      $("#liveview").attr("src", url);
      // todo canvasでdrawImageする
      // ref: http://html5.jp/canvas/how6.html
    };


  </script>
</html>
